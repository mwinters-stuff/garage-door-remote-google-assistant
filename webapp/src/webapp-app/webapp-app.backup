<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<dom-module id="webapp-app">
  <template>
    <style is="custom-style">
      /* :host {
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --app-primary-color: var(--paper-indigo-500);
        --app-secondary-color: black;

      } */

      .content {
        @apply --layout-vertical;
        max-width: 400px;
        margin: 0 auto;
        padding: 16px;
      }
      /* paper-card{
        @apply --paper-font-display3;
      } */
      .value{
        @apply --paper-font-subheading;
        font-weight: bold;
      }
      .label{
        @apply --paper-font-subheading;
      }
    </style>
    <iron-ajax id="getDataAjax" auto url="http://garage-door/all" handle-as="json" last-response="{{_data}}" debounce-duration="300" on-response="_onAllResponse">
    </iron-ajax>
    <iron-ajax id="doorActionAjax" url="http://garage-door/action" handle-as="json" method="GET" params="[[_actionParams]]" debounce-duration="300" on-response="_onActionResponse">
    </iron-ajax>


    <div class="content">
      <paper-card heading="Garage Door">
        <div class="card-content">
          <table fixed-column>
            <tbody>
              <tr>
                <td class="label">Door Action</td>
                <td class="value">[[_data.door_action]]</td>
              </tr>
              <tr>
                <td class="label">Door Position</td>
                <td class="value">[[_data.door_position]]</td>
              </tr>
              <tr>
                <td class="label">Door Locked</td>
                <td class="value">[[_true_false(_data.door_locked)]]</td>
              </tr>
              <tr>
                <td class="label">In Home Area</td>
                <td class="value">[[_true_false(_data.in_home_area)]]</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-actions">
          <paper-button disabled="[[_door_action_enabled(_data.door_position, _data.door_locked)]]" on-tap="_toggle_door">[[_door_action_title(_data.door_position)]]</paper-button>
          <paper-button on-tap="_toggle_locked">[[_door_locked_title(_data.door_locked)]]</paper-button>
          <paper-button on-tap="_go_update">Update</paper-button>
        </div>
      </paper-card>

    </div>
    <!-- </app-header-layout> -->

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class WebappApp extends Polymer.Element {
      static get is() { return 'webapp-app'; }
      // static get properties() {
      //   return {
      //     prop1: {
      //       type: String,
      //       value: 'webapp-app'
      //     }
      //   };
      // }
      constructor() {
        super();
        this._data = null;
        this._actionParams = null;
        // this._onAllResponse();
      }

      _true_false(home) {
        if (home != true && home != false) {//} "" || home == null){
          return "Unknown"
        }
        return home ? "Yes" : "No";
      }

      _door_action_enabled(position, locked) {
        return (position !== "OPEN" && position !== "CLOSED") ||locked;
      }

      _door_action_title(position) {
        if (position === "OPEN") {
          return "Close Door"
        } else if (position === "CLOSED") {
          return "Open Door";
        } if (position === "" || position == null) {
          return "Unknown";
        }
        return "Moving";
      }

      _door_locked_title(locked){
        if(locked === true){
          return 'Unlock';
        } else if (locked == false){
          return 'Lock';
        }
        return 'Noo!!!!';

      }

      _toggle_door() {
        this._actionParams = {
          "door_action": this._data.door_position === "OPEN" ? "CLOSE" : "OPEN"
        };
        this.$.doorActionAjax.generateRequest();
      }

      _toggle_locked() {
        this._actionParams = {
          "lock_action": this._data.door_locked ? "UNLOCK" : "LOCK"
        };
        this.$.doorActionAjax.generateRequest();
        
      }

      _go_update() {
        window.location = "/update"
      }

      _onAllResponse(r){
        console.log("response",r);
        this._intervalID = window.setTimeout(() => {
          this.$.getDataAjax.generateRequest();
        }, 1000);
      }

      _onActionResponse(event){
        console.log("Action Response",event);
      }

    }


    window.customElements.define(WebappApp.is, WebappApp);
  </script>
</dom-module>